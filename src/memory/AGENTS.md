# Memory Guide

## Responsibilities

- `VectorMemory` encrypts stored records, enforces the configured size cap, and runs forward-only migrations on load. Keep schema updates compatible with `CURRENT_VERSION`, preserve AES-256-GCM encryption, and call `_enforceLimits` after mutating stored items to avoid unbounded growth.【F:src/memory/VectorMemory.ts†L1-L136】【F:src/memory/migrations/index.ts†L1-L8】
- Production builds require `MEMORY_ENCRYPTION_KEY`; leave the development warning path intact so local testing can bootstrap with an ephemeral key while still failing fast in production.【F:src/memory/VectorMemory.ts†L23-L48】

## Integration points

- `MemoryManager` composes the vector indexer, retriever, and bounded history services. Coordinate changes across these layers so embeddings, sparse-attention re-ranking, and conversation trimming remain aligned.【F:src/core/memory/MemoryManager.js†L8-L34】【F:src/core/memory/services/VectorIndexer.js†L1-L25】【F:src/core/memory/services/Retriever.js†L1-L35】【F:src/core/memory/services/HistoryService.js†L1-L16】
- Retrieval depends on the same embeddings generated by `llmService`; adjust both memory and service layers together if you change metadata or embedding strategies.【F:src/services/llmService.js†L236-L351】

## Quality signals

- Extend `vectorMemory.test.js` whenever you alter persistence, encryption, or migration behaviour. The suite currently verifies deterministic recall, encryption-at-rest, quota trimming, and production key requirements.【F:**tests**/vectorMemory.test.js†L1-L45】
- Update the architecture guide and related service docs whenever memory semantics change so tooling and orchestrator expectations stay aligned.【F:docs/agent-architecture.md†L9-L36】
