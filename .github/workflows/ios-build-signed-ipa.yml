name: iOS ‚Ä¢ Build Signed IPA

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: Xcode build configuration
        type: choice
        default: Release
        options: [Release, Debug]

env:
  # ==== EDIT THESE TO MATCH YOUR PROJECT ====
  APP_NAME: offLLM
  SCHEME: monGARS # <--- change if your scheme is different
  BUNDLE_ID: com.offllm.mongars
  WORKSPACE: ios/offLLM.xcworkspace # or ios/offLLM.xcodeproj
  CONFIGURATION: ${{ inputs.configuration || 'Release' }}
  TEAM_ID: 52T7P32J34

  # Export method for App Store‚Äìsigned IPA
  EXPORT_METHOD: app-store

jobs:
  build-ipa:
    runs-on: macos-15 # Xcode 16.x / iOS 18.x SDK images
    permissions:
      contents: read

    steps:
      - name: ‚úÖ Validate required signing secrets
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          missing=0
          for var in IOS_P12_BASE64 IOS_P12_PASSWORD IOS_PROVISIONING_PROFILE_BASE64; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing required secret: ${var}." >&2
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "::error::Populate the required signing secrets in the repository settings before running this workflow." >&2
            exit 1
          fi

      - name: üß∞ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: üß± Select newest available Xcode (prefer 16.x)
        shell: bash
        run: |
          set -euo pipefail
          ls -1 /Applications | grep -i "^Xcode" || true
          if [ -d "/Applications/Xcode_16.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
          xcodebuild -version
          xcodebuild -showsdks | sed 's/^/SDK ‚Ä¢ /'

      - name: üç´ Ensure CocoaPods
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods --no-document
          fi
          pod --version

      - name: üì¶ Pod install (if Podfile exists)
        working-directory: ios
        run: |
          set -euo pipefail
          if [ -f "Podfile" ]; then
            pod repo update || true
            pod install --verbose
          else
            echo "No Podfile; skipping pods."
          fi

      - name: üîê Create temporary keychain & import cert
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          KEYPASS="$(openssl rand -hex 12)"
          security create-keychain -p "$KEYPASS" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYPASS" "$KEYCHAIN"
          echo "$P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" -k "$KEYCHAIN" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$KEYCHAIN" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYPASS" "$KEYCHAIN"
          security find-identity -v -p codesigning "$KEYCHAIN"
          echo "KEYCHAIN_PATH=$KEYCHAIN" >> $GITHUB_ENV
          rm -f "$RUNNER_TEMP/cert.p12"

      - name: ü™™ Install provisioning profile
        env:
          PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          PROFILE="$RUNNER_TEMP/profile.mobileprovision"
          echo "$PROFILE_B64" | tr -d '\n\r\t ' | base64 --decode > "$PROFILE"

          PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE" > "$PLIST"

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print:UUID" "$PLIST")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print:Name" "$PLIST")
          rm -f "$PLIST"

          if [[ -z "${PROFILE_UUID:-}" || ! "$PROFILE_UUID" =~ ^[A-Fa-f0-9]{8}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{12}$ ]]; then
            echo "::error::Invalid provisioning profile UUID extracted; verify the IOS_PROVISIONING_PROFILE_BASE64 secret." >&2
            exit 1
          fi

          if [[ -z "${PROFILE_NAME:-}" ]]; then
            echo "::error::Provisioning profile name is empty; verify the IOS_PROVISIONING_PROFILE_BASE64 secret." >&2
            exit 1
          fi

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          mv "$PROFILE" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

          echo "Installed profile UUID: $PROFILE_UUID"
          echo "Provisioning profile name: $PROFILE_NAME"
          echo "PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"

      - name: üßæ Write ExportOptions.plist
        run: |
          set -euo pipefail
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>${EXPORT_METHOD}</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>compileBitcode</key><false/>
            <key>destination</key><string>export</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key><string>${PROFILE_NAME}</string>
            </dict>
            <key>stripSwiftSymbols</key><true/>
            <key>uploadSymbols</key><true/>
            <key>manageAppVersionAndBuildNumber</key><false/>
          </dict>
          </plist>
          EOF
          cat ExportOptions.plist

      - name: üîç Detect signing identity
        run: |
          set -euo pipefail
          KEYCHAIN_ARG=()
          if [[ -n "${KEYCHAIN_PATH:-}" && -f "$KEYCHAIN_PATH" ]]; then
            KEYCHAIN_ARG=("$KEYCHAIN_PATH")
          fi
          ID=$(security find-identity -v -p codesigning "${KEYCHAIN_ARG[@]}" | grep "Apple Distribution" | head -n 1 | sed -n 's/.*"\(.*\)".*/\1/p')
          if [[ -z "${ID:-}" ]]; then
            echo "::error::No signing identity found in ${KEYCHAIN_PATH:-default keychain}" >&2
            exit 1
          fi
          echo "SIGNING_IDENTITY=$ID" >> "$GITHUB_ENV"

      - name: üèóÔ∏è Archive
        shell: bash
        run: |
          set -euo pipefail
          LOG_DIR="$GITHUB_WORKSPACE/build/logs"
          mkdir -p "$LOG_DIR"
          ARCHIVE_LOG="$LOG_DIR/xcodebuild-archive.log"
          ARCHIVE_PATH="$RUNNER_TEMP/${APP_NAME}.xcarchive"
          DESTINATION_FLAGS=(-destination "generic/platform=iOS")
          if [[ "$WORKSPACE" == *.xcworkspace ]]; then
            PROJECT_FLAGS=(-workspace "$WORKSPACE" -scheme "$SCHEME")
          else
            PROJECT_FLAGS=(-project "$WORKSPACE" -scheme "$SCHEME")
          fi
          build_status=0
          CODE_SIGN_ARGS=()
          if [[ -n "${KEYCHAIN_PATH:-}" ]]; then
            CODE_SIGN_ARGS+=(
              CODE_SIGN_KEYCHAIN="${KEYCHAIN_PATH}"
              OTHER_CODE_SIGN_FLAGS="--keychain ${KEYCHAIN_PATH}"
            )
          fi
          set +e
          xcodebuild archive \
            "${PROJECT_FLAGS[@]}" \
            -configuration "$CONFIGURATION" \
            "${DESTINATION_FLAGS[@]}" \
            -archivePath "$ARCHIVE_PATH" \
            -sdk iphoneos \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            CODE_SIGN_IDENTITY="${SIGNING_IDENTITY:-}" \
            CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_REQUIRED=YES \
            "${CODE_SIGN_ARGS[@]}" \
            | tee "$ARCHIVE_LOG" \
            | xcpretty --color
          build_status=${PIPESTATUS[0]}
          set -euo pipefail
          if [ "$build_status" -ne 0 ]; then
            echo "---- SIGNING / PROVISIONING ERRORS (if any) ----"
            grep -nEi "error:.*provision|error:.*codesign|error:.*signing|no matching profiles|requires a provisioning profile|entitlement.*not supported" "$ARCHIVE_LOG" || true
            exit "$build_status"
          fi
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

      - name: üì¶ Export signed IPA
        shell: bash
        run: |
          set -euo pipefail
          LOG_DIR="$GITHUB_WORKSPACE/build/logs"
          mkdir -p "$LOG_DIR"
          EXPORT_LOG="$LOG_DIR/xcodebuild-export.log"
          EXPORT_DIR="$GITHUB_WORKSPACE/build/${APP_NAME}"
          mkdir -p "$EXPORT_DIR"
          set +e
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_DIR" \
            -exportOptionsPlist ExportOptions.plist \
            | tee "$EXPORT_LOG" \
            | xcpretty --color auto
          status=${PIPESTATUS[0]}
          set -euo pipefail
          if [ "$status" -ne 0 ]; then
            exit "$status"
          fi
          ls -lah "$EXPORT_DIR"
          IPA_PATH="$(/usr/bin/find "$EXPORT_DIR" -name "*.ipa" -print -quit)"
          if [ -z "$IPA_PATH" ]; then
            echo "::error::Failed to locate the exported IPA in $EXPORT_DIR (recursive search)" >&2
            exit 1
          fi
          echo "IPA_PATH=$IPA_PATH" >> $GITHUB_ENV
          test -f "$IPA_PATH"

      - name: üß† Collect dSYMs (optional)
        run: |
          set -euo pipefail
          DSYM_DIR="$GITHUB_WORKSPACE/build/${APP_NAME}/dSYMs"
          mkdir -p "$DSYM_DIR"
          if ! find "$ARCHIVE_PATH" -name "*.dSYM" -exec cp -R {} "$DSYM_DIR" \; ; then
            echo "::warning::Failed to collect dSYM files from $ARCHIVE_PATH"
          fi

          if [ -z "$(ls -A "$DSYM_DIR")" ]; then
            echo "::warning::No dSYM files were collected in $DSYM_DIR"
          else
            du -sh "$DSYM_DIR"
          fi

      - name: üìÑ Upload build logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: ios-build-logs
          path: build/logs
          if-no-files-found: warn
          retention-days: 7

      - name: ‚¨ÜÔ∏è Upload IPA artifact
        uses: actions/upload-artifact@v5
        with:
          name: ios-signed-ipa
          path: |
            ${{ env.IPA_PATH }}
            ${{ github.workspace }}/build/${{ env.APP_NAME }}/dSYMs
          retention-days: 7

      - name: üßπ Cleanup signing assets
        if: always()
        env:
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          PROFILE_UUID: ${{ env.PROFILE_UUID }}
        run: |
          set -euo pipefail
          if [ -n "${KEYCHAIN_PATH:-}" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          if [ -n "${PROFILE_UUID:-}" ]; then
            rm -f "$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_UUID}.mobileprovision" || true
          fi
          rm -f ExportOptions.plist || true
