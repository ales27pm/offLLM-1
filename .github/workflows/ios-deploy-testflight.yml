name: iOS â€¢ Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      configuration: { type: choice, options: [Release, Debug], default: Release }
      bump_build_number: { type: boolean, default: true }

env:
  APP_NAME: offLLM
  SCHEME: monGARS
  BUNDLE_ID: com.offllm.mongars
  WORKSPACE: ios/monGARS.xcworkspace
  CONFIGURATION: ${{ inputs.configuration || 'Release' }}
  TEAM_ID: 52T7P32J34
  EXPORT_METHOD: app-store

jobs:
  deploy-testflight:
    runs-on: macos-15
    environment: offLLM
    timeout-minutes: 60
    permissions: { contents: read }

    steps:
      - name: âœ… Validate Secrets
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          set -euo pipefail
          missing=0
          for var in IOS_P12_BASE64 IOS_P12_PASSWORD IOS_PROVISIONING_PROFILE_BASE64 ASC_KEY_ID ASC_ISSUER_ID ASC_PRIVATE_KEY_BASE64; do
            if [ -z "${!var:-}" ]; then echo "::error::Missing $var"; missing=1; fi
          done
          exit $missing

      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }

      - run: bash scripts/ci/select_xcode.sh

      - run: command -v xcpretty >/dev/null 2>&1 || sudo gem install xcpretty --no-document
      - run: command -v pod || sudo gem install cocoapods

      - working-directory: ios
        run: xcodegen generate && pod install --verbose

      - if: ${{ inputs.bump_build_number }}
        run: /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $(date +%Y%m%d%H%M)" ios/MyOfflineLLMApp/Info.plist

      - name: ðŸ” Setup Keychain
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          KEYPASS=$(openssl rand -hex 12)
          security create-keychain -p "$KEYPASS" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYPASS" "$KEYCHAIN"
          echo "$P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" -k "$KEYCHAIN" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$KEYCHAIN" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYPASS" "$KEYCHAIN"
          echo "KEYCHAIN_PATH=$KEYCHAIN" >> $GITHUB_ENV

      - name: ðŸªª Install Profile
        env:
          PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$PROFILE_B64" | base64 --decode > app.mobileprovision
          UUID=$(/usr/libexec/PlistBuddy -c "Print:UUID" /dev/stdin <<< $(security cms -D -i app.mobileprovision))
          mv app.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

      - name: ðŸ§¾ Write ExportOptions
        run: |
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>${EXPORT_METHOD}</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>compileBitcode</key><false/>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key><dict><key>${BUNDLE_ID}</key><string>${PROFILE_UUID}</string></dict>
            <key>stripSwiftSymbols</key><true/>
            <key>uploadSymbols</key><true/>
          </dict></plist>
          EOF

      - name: ðŸ—ï¸ Archive
        run: |
          set -o pipefail
          mkdir -p build/logs
          xcodebuild archive             -workspace "$WORKSPACE"             -scheme "$SCHEME"             -configuration "$CONFIGURATION"             -destination "generic/platform=iOS"             -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive"             PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID"             DEVELOPMENT_TEAM="$TEAM_ID"             CODE_SIGN_STYLE=Manual             CODE_SIGNING_ALLOWED=YES             CODE_SIGNING_REQUIRED=YES             | tee build/logs/archive.log | xcpretty
          echo "ARCHIVE_PATH=$RUNNER_TEMP/${APP_NAME}.xcarchive" >> $GITHUB_ENV

      - name: ðŸ“¦ Export IPA
        run: |
          set -o pipefail
          xcodebuild -exportArchive             -archivePath "$ARCHIVE_PATH"             -exportPath build/output             -exportOptionsPlist ExportOptions.plist             | tee build/logs/export.log | xcpretty

          IPA=$(find build/output -name '*.ipa' -print -quit)
          echo "IPA_PATH=$IPA" >> $GITHUB_ENV

      - name: ðŸš€ Upload
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: bash scripts/ci/upload_testflight.sh "$IPA_PATH" "$ASC_KEY_ID" "$ASC_ISSUER_ID" "$ASC_PRIVATE_KEY_BASE64"

      - if: always()
        run: security delete-keychain "$KEYCHAIN_PATH" || true



# ================= ADDED / UPDATED FILES =================

