name: iOS Deploy to TestFlight

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-testflight:
    runs-on: macos-15
    timeout-minutes: 60
    permissions:
      contents: read

    env:
      APP_NAME: offLLM
      SCHEME: monGARS
      BUNDLE_ID: com.offllm.mongars
      WORKSPACE: ios/monGARS.xcworkspace
      CONFIGURATION: Release
      TEAM_ID: 52T7P32J34
      EXPORT_METHOD: app-store

      IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}

      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üß∞ Select Xcode 16.4
        run: |
          set -euo pipefail
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      - name: üç∫ Install tooling
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen
          command -v xcpretty >/dev/null 2>&1 || sudo gem install xcpretty --no-document
          command -v pod >/dev/null 2>&1 || sudo gem install cocoapods --no-document
          pod --version
          xcodegen --version

      - name: ‚úÖ Validate Base64 secrets (no prints)
        run: |
          set -euo pipefail
          missing=0
          for var in IOS_P12_BASE64 IOS_P12_PASSWORD IOS_PROVISIONING_PROFILE_BASE64 ASC_KEY_ID ASC_ISSUER_ID ASC_PRIVATE_KEY_BASE64; do
            if [ -z "${!var:-}" ]; then echo "::error::Missing $var"; missing=1; fi
          done
          [ "$missing" -eq 0 ] || exit 1

          clean_b64() { printf '%s' "$1" | tr -d '\n\r\t ' ; }
          b64_decode_to() {
            local in="$1"; local out="$2"
            if base64 -D </dev/null >/dev/null 2>&1; then printf '%s' "$in" | base64 -D > "$out"
            else printf '%s' "$in" | base64 --decode > "$out"
            fi
          }

          tmp="$RUNNER_TEMP/b64check"
          mkdir -p "$tmp"
          b64_decode_to "$(clean_b64 "$IOS_P12_BASE64")" "$tmp/cert.p12" || { echo "::error::IOS_P12_BASE64 invalid"; exit 1; }
          b64_decode_to "$(clean_b64 "$ASC_PRIVATE_KEY_BASE64")" "$tmp/key.p8" || { echo "::error::ASC_PRIVATE_KEY_BASE64 invalid"; exit 1; }
          b64_decode_to "$(clean_b64 "$IOS_PROVISIONING_PROFILE_BASE64")" "$tmp/profile.mobileprovision" || { echo "::error::IOS_PROVISIONING_PROFILE_BASE64 invalid"; exit 1; }
          security cms -D -i "$tmp/profile.mobileprovision" >/dev/null || { echo "::error::Invalid .mobileprovision"; exit 1; }

      - name: üîê Setup keychain + import cert
        run: |
          set -euo pipefail
          clean_b64() { printf '%s' "$1" | tr -d '\n\r\t ' ; }
          b64_decode_to() {
            local in="$1"; local out="$2"
            if base64 -D </dev/null >/dev/null 2>&1; then printf '%s' "$in" | base64 -D > "$out"
            else printf '%s' "$in" | base64 --decode > "$out"
            fi
          }

          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          KEYPASS="$(openssl rand -hex 12)"

          security create-keychain -p "$KEYPASS" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYPASS" "$KEYCHAIN"

          CERT_P12="$RUNNER_TEMP/cert.p12"
          b64_decode_to "$(clean_b64 "$IOS_P12_BASE64")" "$CERT_P12"

          security import "$CERT_P12" -k "$KEYCHAIN" -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          security list-keychains -d user -s "$KEYCHAIN" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYPASS" "$KEYCHAIN"

          echo "KEYCHAIN_PATH=$KEYCHAIN" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYPASS" >> "$GITHUB_ENV"
          security find-identity -v -p codesigning "$KEYCHAIN" || true

      - name: ü™™ Install provisioning profile
        run: |
          set -euo pipefail
          clean_b64() { printf '%s' "$1" | tr -d '\n\r\t ' ; }
          b64_decode_to() {
            local in="$1"; local out="$2"
            if base64 -D </dev/null >/dev/null 2>&1; then printf '%s' "$in" | base64 -D > "$out"
            else printf '%s' "$in" | base64 --decode > "$out"
            fi
          }

          OUT="$RUNNER_TEMP/app.mobileprovision"
          b64_decode_to "$(clean_b64 "$IOS_PROVISIONING_PROFILE_BASE64")" "$OUT"

          security cms -D -i "$OUT" > "$RUNNER_TEMP/app.mobileprovision.plist"
          UUID=$(/usr/libexec/PlistBuddy -c "Print:UUID" "$RUNNER_TEMP/app.mobileprovision.plist")

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          mv "$OUT" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "PROFILE_UUID=$UUID" >> "$GITHUB_ENV"

      - name: üßº Purge Xcode caches (fixes RCTDeprecation pcm/modulemap mismatch)
        run: |
          set -euo pipefail
          rm -rf "$HOME/Library/Developer/Xcode/DerivedData"/*
          rm -rf "$HOME/Library/Developer/Xcode/ModuleCache.noindex" || true
          rm -rf "$HOME/Library/Developer/Xcode/DerivedData/ModuleCache.noindex" || true

      - name: üß± Generate Xcode project + install pods (INSIDE ios/)
        working-directory: ios
        run: |
          set -euo pipefail
          xcodegen generate
          pod install --repo-update --verbose

      - name: üîé Detect signing identity
        run: |
          set -euo pipefail
          IDENTITY_LINE="$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep -E 'Apple Distribution|iPhone Distribution|Apple Development|iPhone Developer' | head -n 1 || true)"
          if [ -z "$IDENTITY_LINE" ]; then
            echo "::error::No code signing identity found in keychain."
            security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
            exit 1
          fi
          SIGNING_IDENTITY="$(printf '%s' "$IDENTITY_LINE" | sed -n 's/.*"\(.*\)".*/\1/p')"
          echo "SIGNING_IDENTITY=$SIGNING_IDENTITY" >> "$GITHUB_ENV"
          echo "Using signing identity: $SIGNING_IDENTITY"

      - name: üèóÔ∏è Archive
        run: |
          set -o pipefail
          mkdir -p build/logs

          xcodebuild archive \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
            | tee build/logs/archive.log | xcpretty

          echo "ARCHIVE_PATH=$RUNNER_TEMP/${APP_NAME}.xcarchive" >> "$GITHUB_ENV"

      - name: üßæ Write ExportOptions.plist
        working-directory: ios
        run: |
          set -euo pipefail
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>${EXPORT_METHOD}</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>signingStyle</key><string>manual</string>
            <key>stripSwiftSymbols</key><true/>
            <key>uploadSymbols</key><true/>
          </dict></plist>
          EOF

      - name: üì¶ Export IPA
        run: |
          set -o pipefail
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build/output \
            -exportOptionsPlist ios/ExportOptions.plist \
            | tee build/logs/export.log | xcpretty

          IPA=$(find build/output -name '*.ipa' -print -quit)
          if [ -z "$IPA" ]; then
            echo "::error::No IPA produced."
            exit 1
          fi
          echo "IPA_PATH=$IPA" >> "$GITHUB_ENV"

      - name: üöÄ Upload to TestFlight
        run: |
          set -euo pipefail
          echo "$ASC_PRIVATE_KEY_BASE64" | tr -d '\n\r\t ' | base64 --decode > "$RUNNER_TEMP/AuthKey.p8"

          xcrun altool \
            --upload-app \
            -f "$IPA_PATH" \
            -t ios \
            --apiKey "$ASC_KEY_ID" \
            --apiIssuer "$ASC_ISSUER_ID"

      - if: always()
        name: üßπ Cleanup keychain
        run: |
          security delete-keychain "$KEYCHAIN_PATH" || true
