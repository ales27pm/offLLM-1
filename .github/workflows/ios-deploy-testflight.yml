name: iOS ‚Ä¢ Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: Build configuration
        type: choice
        options: [Release, Debug]
        default: Release
      bump_build_number:
        description: Bump CFBundleVersion
        type: boolean
        default: true

env:
  APP_NAME: offLLM
  SCHEME: monGARS
  BUNDLE_ID: com.offllm.mongars
  WORKSPACE: ios/monGARS.xcworkspace
  CONFIGURATION: ${{ inputs.configuration }}
  TEAM_ID: 52T7P32J34
  EXPORT_METHOD: app-store

jobs:
  deploy-testflight:
    runs-on: macos-15
    environment: offLLM
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: üß∞ Select Xcode
        run: bash scripts/ci/select_xcode.sh

      - name: üç∫ Install tools
        run: |
          brew update
          brew install xcodegen
          sudo gem install xcpretty cocoapods --no-document

      # ------------------ CERTS & PROFILES ------------------

      - name: üîê Setup keychain + cert
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          PASS="$(openssl rand -hex 12)"

          security create-keychain -p "$PASS" "$KEYCHAIN"
          security unlock-keychain -p "$PASS" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"

          python - <<'PY'
          import base64
          import os

          data = os.environ["P12_BASE64"].encode()
          clean = b"".join(data.split())

          with open(os.path.join(os.environ["RUNNER_TEMP"], "cert.p12"), "wb") as f:
              f.write(base64.b64decode(clean))
          PY
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign

          security list-keychains -d user -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$PASS" "$KEYCHAIN"

          echo "KEYCHAIN_PATH=$KEYCHAIN" >> $GITHUB_ENV

      - name: ü™™ Install provisioning profile
        env:
          PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          python - <<'PY'
          import base64
          import os

          data = os.environ["PROFILE_B64"].encode()
          clean = b"".join(data.split())

          with open(os.path.join(os.environ["RUNNER_TEMP"], "app.mobileprovision"), "wb") as f:
              f.write(base64.b64decode(clean))
          PY
          security cms -D -i "$RUNNER_TEMP/app.mobileprovision" > "$RUNNER_TEMP/profile.plist"

          UUID=$(/usr/libexec/PlistBuddy -c "Print:UUID" "$RUNNER_TEMP/profile.plist")
          mv "$RUNNER_TEMP/app.mobileprovision" \
            "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

      # ------------------ PROJECT ------------------

      - name: üß± Generate project + pods
        working-directory: ios
        run: |
          set -euo pipefail
          xcodegen generate
          pod install --repo-update

      - name: üîí Freeze Hermes binary
        run: |
          set -euo pipefail
          HERMES="$(find ios/Pods -name hermes.framework -type d | head -n 1 || true)"
          if [ -n "$HERMES" ]; then
            chmod -R a-w "$HERMES"
          fi

      # ------------------ SCHEME DETECTION ------------------

      - name: üß† Auto-detect app scheme by bundle id
        run: |
          set -euo pipefail
          schemes=$(xcodebuild -list -workspace "$WORKSPACE" \
            | awk '/Schemes:/{f=1;next} f&&NF{gsub(/^[ \t]+/,"");print}')

          matching_schemes=()

          while IFS= read -r s; do
            [ -z "$s" ] && continue

            build_settings=$(xcodebuild -showBuildSettings \
              -workspace "$WORKSPACE" \
              -scheme "$s" \
              -configuration "$CONFIGURATION" 2>/dev/null || true)

            [ -z "$build_settings" ] && continue

            wrapper_extension=$(printf '%s\n' "$build_settings" \
              | awk '/WRAPPER_EXTENSION/ {print $3; exit}')
            [ "$wrapper_extension" != "app" ] && continue

            pid=$(printf '%s\n' "$build_settings" \
              | awk '/PRODUCT_BUNDLE_IDENTIFIER/ {print $3; exit}')

            if [ "$pid" = "$BUNDLE_ID" ]; then
              matching_schemes+=("$s")
            fi
          done <<< "$schemes"

          if [ "${#matching_schemes[@]}" -eq 0 ]; then
            echo "::error::No application scheme found with PRODUCT_BUNDLE_IDENTIFIER=$BUNDLE_ID"
            exit 1
          fi

          if [ "${#matching_schemes[@]}" -gt 1 ]; then
            echo "::error::Multiple application schemes share PRODUCT_BUNDLE_IDENTIFIER=$BUNDLE_ID"
            printf ' - %s\n' "${matching_schemes[@]}"
            echo "Please set SCHEME explicitly or make bundle identifiers unique."
            exit 1
          fi

          echo "‚úÖ Auto-detected app scheme: ${matching_schemes[0]}"
          echo "SCHEME=${matching_schemes[0]}" >> "$GITHUB_ENV"

      # ------------------ BUILD ------------------

      - name: üè∑Ô∏è Set deterministic build number
        if: ${{ inputs.bump_build_number }}
        run: |
          BUILD="${GITHUB_RUN_NUMBER}${GITHUB_RUN_ATTEMPT}"
          /usr/libexec/PlistBuddy \
            -c "Set :CFBundleVersion $BUILD" \
            ios/MyOfflineLLMApp/Info.plist

      - name: üîé Detect signing identity
        run: |
          IDENTITIES=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true)

          DIST_ID=$(printf '%s\n' "$IDENTITIES" | awk -F '"' '/Apple Distribution/ {print $2; exit}')
          DEV_ID=$(printf '%s\n' "$IDENTITIES" | awk -F '"' '/Apple Development/ {print $2; exit}')

          if [ -n "$DIST_ID" ]; then
            ID="$DIST_ID"
          elif [ -n "$DEV_ID" ]; then
            ID="$DEV_ID"
          else
            echo "::error::No signing identity found in keychain $KEYCHAIN_PATH"
            security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
            exit 1
          fi

          echo "Using signing identity: $ID"
          echo "SIGNING_IDENTITY=$ID" >> $GITHUB_ENV

      - name: üèóÔ∏è Archive
        run: |
          set -euo pipefail
          xcodebuild archive \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
            PROVISIONING_PROFILE="$PROFILE_UUID" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            | xcpretty

          echo "ARCHIVE_PATH=$RUNNER_TEMP/${APP_NAME}.xcarchive" >> $GITHUB_ENV

      - name: üì¶ Export IPA
        run: |
          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>$TEAM_ID</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict><key>$BUNDLE_ID</key><string>$PROFILE_UUID</string></dict>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build/output \
            -exportOptionsPlist ios/ExportOptions.plist \
            | xcpretty

          mapfile -t IPA_FILES < <(find build/output -maxdepth 1 -name "*.ipa" -print)
          if [ "${#IPA_FILES[@]}" -eq 0 ]; then
            echo "::error::No IPA file found in build/output"
            exit 1
          fi
          if [ "${#IPA_FILES[@]}" -gt 1 ]; then
            echo "::error::Multiple IPA files found in build/output; please clean the directory"
            printf ' - %s\n' "${IPA_FILES[@]}"
            exit 1
          fi

          echo "IPA_PATH=${IPA_FILES[0]}" >> "$GITHUB_ENV"

      - name: üöÄ Upload to TestFlight
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          bash scripts/ci/upload_testflight.sh \
            "$IPA_PATH" \
            "$ASC_KEY_ID" \
            "$ASC_ISSUER_ID" \
            "$ASC_PRIVATE_KEY_BASE64"
