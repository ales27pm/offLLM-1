name: iOS â€¢ Deploy to TestFlight

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  APP_NAME: offLLM
  SCHEME: monGARS
  BUNDLE_ID: com.offllm.mongars
  WORKSPACE: ios/monGARS.xcworkspace
  CONFIGURATION: Release
  TEAM_ID: 52T7P32J34
  EXPORT_METHOD: app-store

jobs:
  deploy-testflight:
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      - name: Install tooling
        run: |
          brew install xcodegen
          sudo gem install cocoapods xcpretty --no-document

      - name: Purge Xcode caches
        run: |
          rm -rf "$HOME/Library/Developer/Xcode/DerivedData"/*
          rm -rf "$HOME/Library/Developer/Xcode/ModuleCache.noindex" || true

      - name: Create keychain & import cert
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          PASS="$(openssl rand -hex 12)"

          security create-keychain -p "$PASS" "$KEYCHAIN"
          security unlock-keychain -p "$PASS" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"

          echo "$IOS_P12_BASE64" | tr -d '\n\r\t ' | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN" \
            -P "$IOS_P12_PASSWORD" \
            -T /usr/bin/codesign

          security list-keychains -d user -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$PASS" "$KEYCHAIN"

          echo "KEYCHAIN_PATH=$KEYCHAIN" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$PASS" >> $GITHUB_ENV

      - name: Install provisioning profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          PROFILE="$RUNNER_TEMP/profile.mobileprovision"
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | tr -d '\n\r\t ' | base64 --decode > "$PROFILE"

          PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE" > "$PLIST"
          UUID=$(/usr/libexec/PlistBuddy -c "Print:UUID" "$PLIST")
          NAME=$(/usr/libexec/PlistBuddy -c "Print:Name" "$PLIST")

          if [[ -z "${UUID:-}" || -z "${NAME:-}" ]]; then
            echo "::error::Failed to extract provisioning profile UUID or Name" >&2
            exit 1
          fi

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          mv "$PROFILE" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "PROFILE_NAME=$NAME" >> $GITHUB_ENV

      - name: Generate project & install pods
        working-directory: ios
        run: |
          xcodegen generate
          pod install --repo-update

      - name: Detect signing identity
        run: |
          ID=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Apple Distribution" | head -n 1 | sed -n 's/.*"\(.*\)".*/\1/p')
          echo "SIGNING_IDENTITY=$ID" >> $GITHUB_ENV

      - name: Archive
        run: |
          set -euo pipefail
          LOG_DIR="$RUNNER_TEMP/build-logs"
          mkdir -p "$LOG_DIR"
          ARCHIVE_LOG="$LOG_DIR/xcodebuild-archive.log"
          xcodebuild archive \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
            ${KEYCHAIN_PATH:+CODE_SIGN_KEYCHAIN="$KEYCHAIN_PATH"} \
            ${KEYCHAIN_PATH:+OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH"} \
            -sdk iphoneos \
            | tee "$ARCHIVE_LOG" | xcpretty

          build_status=${PIPESTATUS[0]}
          if [ "$build_status" -ne 0 ]; then
            echo "---- SIGNING / PROVISIONING ERRORS (if any) ----"
            grep -nE "error:|No profiles|provision|Provisioning|CodeSign|codesign|Signing|entitlement|requires a provisioning profile" "$ARCHIVE_LOG" || true
            exit "$build_status"
          fi

      - name: Export IPA
        run: |
          set -euo pipefail
          cat > "$RUNNER_TEMP/export.plist" <<EOF
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>$TEAM_ID</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$BUNDLE_ID</key><string>$PROFILE_NAME</string>
            </dict>
          </dict></plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist "$RUNNER_TEMP/export.plist"

      - name: Upload to TestFlight
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          echo "$ASC_PRIVATE_KEY_BASE64" | tr -d '\n\r\t ' | base64 --decode > "$RUNNER_TEMP/AuthKey.p8"
          xcrun altool --upload-app \
            -f "$RUNNER_TEMP/export/${SCHEME}.ipa" \
            -t ios \
            --apiKey "$ASC_KEY_ID" \
            --apiIssuer "$ASC_ISSUER_ID"
