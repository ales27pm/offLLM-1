name: iOS Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      bump_build_number:
        description: Bump CFBundleVersion (date-based)
        type: boolean
        default: true

env:
  APP_NAME: offLLM
  SCHEME: monGARS
  BUNDLE_ID: com.offllm.mongars
  WORKSPACE: ios/monGARS.xcworkspace
  TEAM_ID: 52T7P32J34
  EXPORT_METHOD: app-store

jobs:
  deploy-testflight:
    runs-on: macos-15
    environment: offLLM
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ§° Select Xcode
        run: bash scripts/ci/select_xcode.sh 16

      - name: ðŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ðŸ“¦ Install JS dependencies
        run: |
          set -euo pipefail
          npm ci

      - name: ðŸ’Ž Setup Ruby + Bundler cache
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: ðŸº Install XcodeGen
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen
          xcodegen --version

      - name: âœ… Validate required secrets exist
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          set -euo pipefail
          missing=0
          for var in IOS_P12_BASE64 IOS_P12_PASSWORD IOS_PROVISIONING_PROFILE_BASE64 ASC_KEY_ID ASC_ISSUER_ID ASC_PRIVATE_KEY_BASE64; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing $var"
              missing=1
            fi
          done
          [ "$missing" -eq 0 ] || exit 1

      - name: ðŸ” Setup Keychain + Import Distribution Cert
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: bash scripts/ci/setup_keychain.sh

      - name: ðŸªª Install Provisioning Profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: bash scripts/ci/install_profile.sh

      - name: ðŸ§± Ensure resource dirs exist (prevents XcodeGen failure)
        run: |
          set -euo pipefail
          mkdir -p ios/MyOfflineLLMApp/Resources ios/MyOfflineLLMApp/Models

      - name: ðŸ§± Generate Xcode project (XcodeGen)
        working-directory: ios
        run: |
          set -euo pipefail
          xcodegen generate

      - name: ðŸ“¦ CocoaPods install
        run: |
          set -euo pipefail
          bundle exec pod install --project-directory=ios --verbose
          test -d "${WORKSPACE}" || { echo "::error::Workspace missing: ${WORKSPACE}"; exit 1; }

      - name: ðŸ©¹ Repair shared scheme to support ArchiveAction
        run: |
          set -euo pipefail
          python3 scripts/ci/repair_xcode_scheme.py --ios-dir ios --workspace "${WORKSPACE}" --scheme "${SCHEME}"

      - name: ðŸ”Ž Preflight - list workspace schemes
        run: |
          set -euo pipefail
          xcodebuild -list -workspace "${WORKSPACE}"

      - name: ðŸ·ï¸ Bump build number
        if: ${{ inputs.bump_build_number }}
        run: |
          set -euo pipefail
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $(date +%Y%m%d%H%M)" ios/MyOfflineLLMApp/Info.plist

      - name: ðŸ§¾ Write ExportOptions.plist
        working-directory: ios
        run: |
          set -euo pipefail
          PROFILE_REF="${PROFILE_NAME:-$PROFILE_UUID}"

          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>${EXPORT_METHOD}</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key><string>${PROFILE_REF}</string>
            </dict>
            <key>stripSwiftSymbols</key><true/>
            <key>uploadSymbols</key><true/>
          </dict></plist>
          EOF

      - name: ðŸ”Ž Detect signing identity
        run: |
          set -euo pipefail
          IDENTITY_LINE="$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" \
            | grep -E 'Apple Distribution|iPhone Distribution' | head -n 1 || true)"
          if [ -z "$IDENTITY_LINE" ]; then
            echo "::error::No Apple Distribution identity found in keychain."
            security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
            exit 1
          fi
          SIGNING_IDENTITY="$(printf '%s' "$IDENTITY_LINE" | sed -n 's/.*"\(.*\)".*/\1/p')"
          echo "SIGNING_IDENTITY=$SIGNING_IDENTITY" >> "$GITHUB_ENV"
          echo "Using signing identity: $SIGNING_IDENTITY"

      - name: ðŸ—ï¸ Archive (prints raw log tail on failure)
        run: |
          set -euo pipefail
          mkdir -p build/logs

          RAW_LOG="build/logs/archive-xcodebuild-raw.log"
          RESULT_BUNDLE="$RUNNER_TEMP/archive.xcresult"

          EXTRA_PROFILE_ARGS=()
          if [ -n "${PROFILE_NAME:-}" ]; then
            EXTRA_PROFILE_ARGS+=( "PROVISIONING_PROFILE_SPECIFIER=$PROFILE_NAME" )
          fi

          set +e
          xcodebuild archive \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            -derivedDataPath "$RUNNER_TEMP/DerivedData" \
            -resultBundlePath "$RESULT_BUNDLE" \
            CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_REQUIRED=YES \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            "${EXTRA_PROFILE_ARGS[@]}" \
            2>&1 | tee "$RAW_LOG"
          xc_status=${PIPESTATUS[0]}
          set -e

          if [ "$xc_status" -ne 0 ]; then
            echo "::error::xcodebuild archive failed (exit $xc_status)"
            echo "---- tail (raw xcodebuild) ----"
            tail -n 200 "$RAW_LOG" || true
            exit "$xc_status"
          fi

          echo "ARCHIVE_PATH=$RUNNER_TEMP/${APP_NAME}.xcarchive" >> "$GITHUB_ENV"

      - name: ðŸ“¦ Export IPA
        run: |
          set -euo pipefail
          mkdir -p build/output

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build/output \
            -exportOptionsPlist ios/ExportOptions.plist

          IPA="$(find build/output -name '*.ipa' -print -quit)"
          if [ -z "$IPA" ]; then
            echo "::error::No IPA produced."
            exit 1
          fi
          echo "IPA_PATH=$IPA" >> "$GITHUB_ENV"
          echo "IPA: $IPA"

      - name: ðŸš€ Upload to TestFlight (Fastlane pilot)
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
          IPA_PATH: ${{ env.IPA_PATH }}
        run: |
          set -euo pipefail
          bundle exec fastlane ios upload_testflight ipa:"$IPA_PATH"

      - name: ðŸ§¹ Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_PATH" || true
