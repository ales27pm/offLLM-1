name: iOS Deploy to TestFlight

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-testflight:
    runs-on: macos-15

    env:
      APP_NAME: offLLM
      SCHEME: monGARS
      BUNDLE_ID: com.offllm.mongars
      WORKSPACE: ios/monGARS.xcworkspace
      CONFIGURATION: Release
      TEAM_ID: 52T7P32J34
      EXPORT_METHOD: app-store

      IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}

      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      - name: Install tooling
        run: |
          brew update
          brew install xcodegen
          command -v xcpretty >/dev/null 2>&1 || sudo gem install xcpretty --no-document
          command -v pod >/dev/null 2>&1 || sudo gem install cocoapods --no-document
          pod --version

      - name: Validate Base64 secrets
        run: |
          set -euo pipefail

          missing=0
          for var in IOS_P12_BASE64 IOS_P12_PASSWORD IOS_PROVISIONING_PROFILE_BASE64 ASC_KEY_ID ASC_ISSUER_ID ASC_PRIVATE_KEY_BASE64; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing $var"
              missing=1
            fi
          done
          [ "$missing" -eq 0 ] || exit 1

          clean_b64() { printf '%s' "$1" | tr -d '\n\r\t ' ; }

          b64_decode_to() {
            local in="$1"; local out="$2"
            # macOS decoder
            printf '%s' "$in" | base64 -D > "$out"
          }

          mkdir -p "$RUNNER_TEMP/b64check"
          b64_decode_to "$(clean_b64 "$IOS_P12_BASE64")" "$RUNNER_TEMP/b64check/cert.p12"
          b64_decode_to "$(clean_b64 "$ASC_PRIVATE_KEY_BASE64")" "$RUNNER_TEMP/b64check/key.p8"
          b64_decode_to "$(clean_b64 "$IOS_PROVISIONING_PROFILE_BASE64")" "$RUNNER_TEMP/b64check/profile.mobileprovision"

          security cms -D -i "$RUNNER_TEMP/b64check/profile.mobileprovision" >/dev/null

      - name: Create and unlock keychain
        run: |
          set -euo pipefail

          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          KEYPASS="$(openssl rand -hex 12)"

          security create-keychain -p "$KEYPASS" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYPASS" "$KEYCHAIN"

          echo "KEYCHAIN_PATH=$KEYCHAIN" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYPASS" >> "$GITHUB_ENV"

      - name: Import signing certificate
        run: |
          set -euo pipefail

          printf '%s' "$IOS_P12_BASE64" | tr -d '\n\r\t ' | base64 -D > "$RUNNER_TEMP/cert.p12"

          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$IOS_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        run: |
          set -euo pipefail

          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          printf '%s' "$IOS_PROVISIONING_PROFILE_BASE64" | tr -d '\n\r\t ' | base64 -D > "$PROFILE_PATH"

          PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE_PATH" > "$PLIST"

          UUID=$(/usr/libexec/PlistBuddy -c "Print:UUID" "$PLIST")
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          mv "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "PROFILE_UUID=$UUID" >> "$GITHUB_ENV"

      - name: Generate Xcode project & install pods
        working-directory: ios
        run: |
          set -euo pipefail
          xcodegen generate
          pod install --repo-update --verbose

      - name: Build & archive
        run: |
          set -euo pipefail

          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$RUNNER_TEMP/$SCHEME.xcarchive" \
            -destination generic/platform=iOS \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
            CODE_SIGN_STYLE=Manual \
            archive | xcpretty

      - name: Export IPA
        run: |
          set -euo pipefail

          cat > "$RUNNER_TEMP/exportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
          "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>teamID</key><string>$TEAM_ID</string>
            <key>uploadBitcode</key><false/>
            <key>uploadSymbols</key><true/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/$SCHEME.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist "$RUNNER_TEMP/exportOptions.plist"

      - name: Upload to TestFlight
        run: |
          set -euo pipefail

          printf '%s' "$ASC_PRIVATE_KEY_BASE64" | tr -d '\n\r\t ' | base64 -D > "$RUNNER_TEMP/AuthKey.p8"

          xcrun altool \
            --upload-app \
            -f "$RUNNER_TEMP/export/$SCHEME.ipa" \
            -t ios \
            --apiKey "$ASC_KEY_ID" \
            --apiIssuer "$ASC_ISSUER_ID"
